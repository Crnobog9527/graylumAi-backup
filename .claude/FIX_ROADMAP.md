# 项目修复路线图

> 基于 TROUBLESHOOTING.md 和 HEALTH_REPORT.md 的问题分析
> 生成日期：2026-01-11
> 评估方法：优先级得分 = (影响范围 × 严重程度 × 发生频率) / 修复难度

---

## 问题统计摘要

### 问题分类统计

| 分类 | 问题数量 | 占比 |
|------|----------|------|
| 代码架构问题 | 3 | 17% |
| AI 系统问题 | 4 | 24% |
| UI/UX 问题 | 2 | 12% |
| 后端云函数问题 | 3 | 17% |
| 构建部署问题 | 2 | 12% |
| 性能优化问题 | 3 | 18% |
| **总计** | **17** | **100%** |

### 优先级分布

| 优先级 | 问题数量 | 处理时限 |
|--------|----------|----------|
| **P0 紧急** | 6 | 本周内 |
| **P1 高优先级** | 2 | 本月内 |
| **P2 中优先级** | 6 | 本季度 |
| **P3 低优先级** | 3 | 可推迟 |

---

## 修复计划优先级清单

### P0 - 紧急修复（本周内）

#### 1. AdminAnnouncements.jsx 文件过大
**优先级得分: 31.25**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 5 (开发者、构建系统、代码审查) |
| 严重程度 | 5 (IDE 卡顿、构建性能下降) |
| 发生频率 | 5 (每次开发都遇到) |
| 修复难度 | 4 (需要仔细拆分测试) |

**影响**：
- IDE 打开文件缓慢或卡死 (48,524 行)
- 构建性能下降
- 代码审查困难
- 新成员上手困难

**解决方案**：
```
拆分为 6-8 个子模块：
src/components/admin/announcements/
├── index.jsx                 # 主入口
├── AnnouncementList.jsx      # 公告列表
├── AnnouncementForm.jsx      # 公告表单
├── AnnouncementPreview.jsx   # 公告预览
├── AnnouncementFilters.jsx   # 筛选器
├── AnnouncementStats.jsx     # 统计数据
└── hooks/
    └── useAnnouncements.js   # 状态管理
```

**依赖**：无，可直接开始

---

#### 2. Token 消耗过高
**优先级得分: 21.33**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 (付费用户、成本核算) |
| 严重程度 | 4 (成本超出预算) |
| 发生频率 | 4 (持续问题) |
| 修复难度 | 3 (需要分析调优) |

**影响**：
- 用户积分消耗过快
- 运营成本超出预期
- 单次对话消耗大量 Token

**解决方案**：
- 验证 Prompt Caching 是否正常工作
- 优化系统提示词长度
- 确保 Haiku 模型用于简单任务
- 添加 Token 使用监控面板

**依赖**：需要先了解 callAIModel.ts 逻辑

**相关文件**：
- `functions/callAIModel.ts`
- `functions/smartChatWithSearch.ts`

---

#### 3. 前端代码分割优化
**优先级得分: 20.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 (所有用户) |
| 严重程度 | 3 (性能问题) |
| 发生频率 | 5 (持续存在) |
| 修复难度 | 3 (技术成熟) |

**影响**：
- 首屏加载时间过长
- 用户体验下降
- 移动端性能问题

**解决方案**：
```javascript
// 使用 React.lazy 实现路由级代码分割
const Chat = React.lazy(() => import('./pages/Chat'));
const Admin = React.lazy(() => import('./pages/Admin'));

// 添加 Suspense 和 Loading 状态
<Suspense fallback={<Loading />}>
  <Routes>...</Routes>
</Suspense>
```

**依赖**：无

**相关文件**：
- `src/pages.config.js`
- `src/App.jsx`

---

#### 4. 图片懒加载
**优先级得分: 20.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 (所有用户) |
| 严重程度 | 2 (性能优化) |
| 发生频率 | 5 (持续) |
| 修复难度 | 2 (简单实现) |

**解决方案**：
```jsx
// 使用 loading="lazy" 属性
<img src={imageUrl} loading="lazy" alt="..." />

// 或使用 Intersection Observer
const [isVisible, setIsVisible] = useState(false);
const imgRef = useRef();

useEffect(() => {
  const observer = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) {
      setIsVisible(true);
      observer.disconnect();
    }
  });
  observer.observe(imgRef.current);
  return () => observer.disconnect();
}, []);
```

**依赖**：无

---

#### 5. AI 响应缓慢或超时
**优先级得分: 20.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 5 (所有用户) |
| 严重程度 | 4 (核心功能受影响) |
| 发生频率 | 3 (偶尔发生) |
| 修复难度 | 3 (需要调优) |

**解决方案**：
- 优化模型选择策略
- 实现指数退避重试机制
- 检查 Token 预算设置
- 添加超时监控

**依赖**：需要访问 callAIModel.ts

**相关文件**：
- `functions/callAIModel.ts`

---

#### 6. 聊天上下文丢失
**优先级得分: 20.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 5 (所有用户) |
| 严重程度 | 4 (核心功能问题) |
| 发生频率 | 3 (部分用户遇到) |
| 修复难度 | 3 (需要调试状态) |

**解决方案**：
- 检查 useChatState.js 状态管理
- 验证对话历史传递逻辑
- 检查 Token 限制是否导致截断
- 优化 compressConversation.ts 压缩策略

**依赖**：无

**相关文件**：
- `src/components/hooks/useChatState.jsx`
- `functions/compressConversation.ts`
- `functions/smartChatWithSearch.ts`

---

### P1 - 高优先级（本月内）

#### 7. 文档系统整合
**优先级得分: 15.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 3 (开发者) |
| 严重程度 | 2 (效率问题) |
| 发生频率 | 5 (持续存在) |
| 修复难度 | 2 (工作量适中) |

**影响**：
- 多个分散文档导致信息分散
- 新成员不知道看哪个文档
- 文档维护效率低

**解决方案**：
- 审查现有文档与 .claude/ 系统的关系
- 整合内容到 .claude/ 目录
- 归档过时文档
- 建立文档更新流程

**待整合文档**：
- `CLAUDE_CODE_INSTRUCTIONS.md` → 整合到 .claude/
- `HANDOFF_GUIDE.md` → 整合到 .claude/
- `DESIGN_SYSTEM_PROGRESS.md` → 保留并链接

**依赖**：无

---

#### 8. 暗色模式样式异常
**优先级得分: 12.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 3 (使用暗色模式的用户) |
| 严重程度 | 2 (视觉问题) |
| 发生频率 | 4 (持续存在) |
| 修复难度 | 2 (逐步修复) |

**解决方案**：
- 检查 src/index.css 中的 CSS Variables
- 确保所有组件使用主题变量
- 使用 shadcn/ui 组件
- 使用 `dark:` 前缀定义样式

**依赖**：无

---

### P2 - 中优先级（本季度）

#### 9. 智能搜索不生效
**优先级得分: 9.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 3 |
| 严重程度 | 3 |
| 发生频率 | 2 |
| 修复难度 | 2 |

**解决方案**：
- 检查 SystemSettings 中搜索开关
- 验证 searchClassifier.ts 逻辑
- 检查搜索缓存配置

---

#### 10. 移动端布局错乱
**优先级得分: 9.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 3 |
| 严重程度 | 3 |
| 发生频率 | 3 |
| 修复难度 | 3 |

**解决方案**：
- 使用 Tailwind 响应式类
- 验证 use-mobile.jsx Hook
- 逐页测试移动端适配

---

#### 11. 云函数冷启动慢
**优先级得分: 9.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 |
| 严重程度 | 3 |
| 发生频率 | 3 |
| 修复难度 | 4 |

**解决方案**：
- 减少函数依赖项
- 延迟加载非必要模块
- 评估大型云函数拆分

---

#### 12. 大型云函数评估
**优先级得分: 6.75**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 3 |
| 严重程度 | 3 |
| 发生频率 | 3 |
| 修复难度 | 4 |

**涉及文件**：
- `smartChatWithSearch.ts` (31,478行)
- `callAIModel.ts` (27,164行)

**评估内容**：
- 冷启动时间影响
- 代码耦合度
- 拆分可行性和收益

---

#### 13. 缺少前端性能监控
**优先级得分: 6.67**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 2 |
| 严重程度 | 2 |
| 发生频率 | 5 |
| 修复难度 | 3 |

**解决方案**：
- 实施 Core Web Vitals 监控
- 添加 FCP、LCP、TTI 指标
- 考虑使用 Web Vitals 库

---

#### 14. 云函数返回错误处理
**优先级得分: 16.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 |
| 严重程度 | 4 |
| 发生频率 | 2 |
| 修复难度 | 2 |

**解决方案**：
- 完善错误处理机制
- 统一错误码规范
- 前端友好错误提示

---

### P3 - 低优先级（可推迟）

#### 15. AdminFeatured.jsx 空文件
**优先级得分: 1.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 1 |
| 严重程度 | 1 |
| 发生频率 | 1 |
| 修复难度 | 1 |

**处理方式**：
- 确认该功能是否需要
- 如已废弃，删除文件
- 如需实现，添加到后续开发计划

---

#### 16. npm run build 失败（偶发）
**优先级得分: 25.00** (但因偶发降为 P3)

**处理方式**：
- 保持诊断步骤文档
- 作为常见问题解决方案储备

---

#### 17. 部署后功能异常（偶发）
**优先级得分: 16.67** (但因偶发降为 P3)

**处理方式**：
- 保持诊断步骤文档
- 确保环境变量配置完整

---

## 修复路线图

### 第1周（2026-01-13 到 2026-01-19）
**本周目标**：解决 3 个 P0 问题

#### 周一-周二：AdminAnnouncements.jsx 拆分（第一阶段）
- **负责文件**：`src/pages/AdminAnnouncements.jsx`
- **预期成果**：
  - 分析文件结构，识别可拆分模块
  - 创建组件目录结构
  - 拆分 AnnouncementList 组件

- [ ] 分析 AdminAnnouncements.jsx 代码结构
- [ ] 创建 src/components/admin/announcements/ 目录
- [ ] 拆分 AnnouncementList.jsx
- [ ] 验证功能正常

#### 周三-周四：继续拆分 + Token 消耗优化
- **负责文件**：
  - `src/pages/AdminAnnouncements.jsx`
  - `functions/callAIModel.ts`
- **预期成果**：
  - 拆分 AnnouncementForm 和 AnnouncementPreview
  - 分析 Token 使用情况
  - 验证 Prompt Caching 配置

- [ ] 拆分 AnnouncementForm.jsx
- [ ] 拆分 AnnouncementPreview.jsx
- [ ] 检查 Prompt Caching 配置
- [ ] 添加 Token 使用日志

#### 周五：测试和验证
- [ ] 回归测试 AdminAnnouncements 功能
- [ ] 验证 Token 消耗变化
- [ ] 更新文档

---

### 第2周（2026-01-20 到 2026-01-26）
**本周目标**：完成代码分割，解决剩余 P0 问题

#### 周一-周二：前端代码分割
- **负责文件**：
  - `src/pages.config.js`
  - `src/App.jsx`
- **预期成果**：
  - 实现路由级 React.lazy 加载
  - 添加 Suspense 和 Loading 状态

- [ ] 修改 pages.config.js 使用 React.lazy
- [ ] 添加 Suspense 包装
- [ ] 创建 Loading 组件
- [ ] 测试各页面加载

#### 周三-周四：AI 响应优化
- **负责文件**：
  - `functions/callAIModel.ts`
  - `functions/smartChatWithSearch.ts`
- **预期成果**：
  - 优化模型选择策略
  - 添加重试机制
  - 修复上下文丢失问题

- [ ] 优化模型选择逻辑
- [ ] 添加指数退避重试
- [ ] 检查上下文传递逻辑
- [ ] 验证修复效果

#### 周五：图片懒加载 + 测试
- [ ] 实现图片懒加载
- [ ] 全面功能测试
- [ ] 更新文档

---

### 第3-4周（本月剩余时间）
**目标**：处理 P1 问题

#### 文档系统整合
- [ ] 审查现有文档
- [ ] 整合 CLAUDE_CODE_INSTRUCTIONS.md
- [ ] 整合 HANDOFF_GUIDE.md
- [ ] 建立文档更新流程

#### 暗色模式修复
- [ ] 审查 CSS Variables 定义
- [ ] 逐页检查暗色模式
- [ ] 修复发现的问题
- [ ] 建立样式审查清单

---

### 第2-3个月
**目标**：处理 P2 问题

#### 月度任务
- [ ] 智能搜索功能排查
- [ ] 移动端布局修复
- [ ] 云函数冷启动优化
- [ ] 大型云函数评估
- [ ] 前端性能监控实施
- [ ] 错误处理机制完善

---

## 问题依赖关系

```
AdminAnnouncements 拆分 → 独立进行，无阻塞
                ↓
     提升开发效率后可加速其他任务

Token 消耗优化 → 需要先理解 callAIModel.ts
                ↓
         阻塞 → AI 响应优化

前端代码分割 → 独立进行
                ↓
    可与图片懒加载并行

聊天上下文丢失 → 需要先分析 useChatState.jsx
                ↓
       可能阻塞 → AI 响应优化
```

**关键路径**：
1. 必须先解决 [AdminAnnouncements 拆分]，才能高效处理其他代码问题
2. [Token 消耗优化] 会同时改善 [AI 响应速度] 和 [成本控制]
3. [前端代码分割] 完成后可显著提升用户体验

---

## 资源分配

### Claude Code 任务（可自动化）
- [x] 分析文件结构
- [x] 生成拆分计划
- [ ] 代码分割实现
- [ ] 组件拆分实现
- [ ] 添加日志监控代码
- [ ] 文档整合和更新

### 需要人工决策的任务
- [ ] 确认 AdminFeatured.jsx 是否需要
- [ ] 确定 Token 预算策略
- [ ] 审批重大架构变更
- [ ] 选择性能监控工具

### 需要外部支持的任务
- [ ] Base44 平台云函数配置
- [ ] 生产环境验证
- [ ] API 成本核算

---

## 下一步行动

### 立即开始（今天）

#### 1. 开始 AdminAnnouncements.jsx 分析
```
提示词：
请分析 src/pages/AdminAnnouncements.jsx 文件的结构，
识别可以拆分的独立模块，并创建详细的拆分计划。
要求：
1. 列出所有可拆分的组件
2. 说明每个组件的职责
3. 标注组件间的依赖关系
4. 预估拆分工作量
```

#### 2. 检查 Token 使用情况
```
提示词：
请检查 functions/callAIModel.ts 中的 Prompt Caching 配置，
验证是否正确实现，并添加 Token 使用详细日志。
```

### 本周内启动

#### 3. 前端代码分割
```
提示词：
请将 src/pages.config.js 中的页面导入改为 React.lazy 懒加载，
并在 App.jsx 中添加 Suspense 和 Loading 组件。
```

#### 4. 图片懒加载实现
```
提示词：
请为项目中的图片组件添加懒加载支持，
使用 loading="lazy" 属性或 Intersection Observer API。
```

### 需要先做的准备工作
- [ ] 备份当前代码（已有 Git）
- [ ] 创建功能分支
- [ ] 确认测试环境可用
- [ ] 准备回滚方案

---

## 风险提示

### 高风险修复项

| 问题 | 风险说明 | 缓解措施 |
|------|----------|----------|
| AdminAnnouncements 拆分 | 可能影响现有功能 | 分步拆分，每步测试 |
| 前端代码分割 | 可能影响路由导航 | 充分测试各页面跳转 |
| AI 响应优化 | 可能影响模型选择 | 保留回滚配置 |

### 需要特别注意

1. **AdminAnnouncements 拆分**
   - 拆分前备份原文件
   - 每拆分一个组件就测试
   - 保持导入路径兼容性

2. **Token 优化**
   - 不要过度压缩上下文
   - 保持用户体验优先
   - 监控成本变化

3. **代码分割**
   - 确保 Loading 状态友好
   - 测试弱网环境加载
   - 验证 SEO 影响

---

## 成功指标

| 指标 | 当前值 | 目标值 | 验证方法 |
|------|--------|--------|----------|
| 最大文件行数 | 48,524 | < 1,000 | `wc -l` |
| 首屏加载时间 | ~3s | < 1.5s | Lighthouse |
| Token 缓存命中率 | 未知 | > 80% | 日志监控 |
| IDE 响应时间 | 卡顿 | 正常 | 开发者反馈 |
| 开发效率 | 基准 | +50% | 任务完成时间 |

---

*路线图生成时间：2026-01-11*
*下次更新：每周五*
*负责团队：Grayscale Development Team*
