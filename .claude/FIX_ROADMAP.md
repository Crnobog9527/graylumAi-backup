# 项目修复路线图

> 基于 TROUBLESHOOTING.md 和 HEALTH_REPORT.md 的问题分析
> 生成日期：2026-01-11
> **更新日期：2026-01-11（数据修正）**
> 评估方法：优先级得分 = (影响范围 × 严重程度 × 发生频率) / 修复难度

---

## 重要更新

> **2026-01-11 数据修正**
>
> 经实际验证，之前文档中的文件大小数据存在严重错误：
>
> | 文件 | 原记录 | 实际行数 |
> |------|--------|----------|
> | AdminAnnouncements.jsx | 48,524 行 | **1,116 行** |
> | smartChatWithSearch.ts | 31,478 行 | **752 行** |
> | callAIModel.ts | 27,164 行 | **679 行** |
> | useChatState.jsx | 22,855 行 | **691 行** |
>
> **结论**：所有文件大小均在合理范围内，无需紧急拆分。
> 优先级已重新调整。

---

## 问题统计摘要

### 问题分类统计

| 分类 | 问题数量 | 占比 |
|------|----------|------|
| AI 系统问题 | 4 | 31% |
| UI/UX 问题 | 2 | 15% |
| 性能优化问题 | 3 | 23% |
| 构建部署问题 | 2 | 15% |
| 文档整合问题 | 2 | 16% |
| **总计** | **13** | **100%** |

### 修正后优先级分布

| 优先级 | 问题数量 | 处理时限 |
|--------|----------|----------|
| **P0 紧急** | 0 | - |
| **P1 高优先级** | 4 | 本月内 |
| **P2 中优先级** | 6 | 本季度 |
| **P3 低优先级** | 3 | 可推迟 |

---

## 修复计划优先级清单

### P1 - 高优先级（本月内）

#### 1. Token 消耗优化
**优先级得分: 21.33**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 (付费用户、成本核算) |
| 严重程度 | 4 (成本问题) |
| 发生频率 | 4 (持续问题) |
| 修复难度 | 3 (需要分析调优) |

**解决方案**：
- 验证 Prompt Caching 是否正常工作
- 优化系统提示词长度
- 确保 Haiku 模型用于简单任务
- 添加 Token 使用监控面板

**相关文件**：
- `functions/callAIModel.ts` (679行)
- `functions/smartChatWithSearch.ts` (752行)

---

#### 2. 前端代码分割
**优先级得分: 20.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 (所有用户) |
| 严重程度 | 3 (性能问题) |
| 发生频率 | 5 (持续存在) |
| 修复难度 | 3 (技术成熟) |

**解决方案**：
```javascript
// 使用 React.lazy 实现路由级代码分割
const Chat = React.lazy(() => import('./pages/Chat'));
const Admin = React.lazy(() => import('./pages/Admin'));

// 添加 Suspense 和 Loading 状态
<Suspense fallback={<Loading />}>
  <Routes>...</Routes>
</Suspense>
```

**相关文件**：
- `src/pages.config.js`
- `src/App.jsx`

---

#### 3. AI 响应优化
**优先级得分: 20.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 5 (所有用户) |
| 严重程度 | 4 (核心功能) |
| 发生频率 | 3 (偶尔发生) |
| 修复难度 | 3 (需要调优) |

**解决方案**：
- 优化模型选择策略
- 实现指数退避重试机制
- 检查 Token 预算设置
- 添加超时监控

---

#### 4. 图片懒加载
**优先级得分: 20.00**

| 评估维度 | 得分 (1-5) |
|----------|-----------|
| 影响范围 | 4 (所有用户) |
| 严重程度 | 2 (性能优化) |
| 发生频率 | 5 (持续) |
| 修复难度 | 2 (简单实现) |

**解决方案**：
```jsx
// 使用 loading="lazy" 属性
<img src={imageUrl} loading="lazy" alt="..." />
```

---

### P2 - 中优先级（本季度）

#### 5. 文档系统整合
**优先级得分: 15.00**

**待整合文档**：
- `CLAUDE_CODE_INSTRUCTIONS.md` → 整合到 .claude/
- `HANDOFF_GUIDE.md` → 整合到 .claude/
- `DESIGN_SYSTEM_PROGRESS.md` → 保留并链接

---

#### 6. 暗色模式样式优化
**优先级得分: 12.00**

**解决方案**：
- 检查 src/index.css 中的 CSS Variables
- 确保所有组件使用主题变量
- 使用 `dark:` 前缀定义样式

---

#### 7. 智能搜索功能验证
**优先级得分: 9.00**

**解决方案**：
- 检查 SystemSettings 中搜索开关
- 验证 searchClassifier.ts 逻辑
- 检查搜索缓存配置

---

#### 8. 移动端布局优化
**优先级得分: 9.00**

**解决方案**：
- 使用 Tailwind 响应式类
- 验证 use-mobile.jsx Hook
- 逐页测试移动端适配

---

#### 9. 云函数冷启动优化
**优先级得分: 9.00**

**解决方案**：
- 减少函数依赖项
- 延迟加载非必要模块

---

#### 10. 前端性能监控
**优先级得分: 6.67**

**解决方案**：
- 实施 Core Web Vitals 监控
- 添加 FCP、LCP、TTI 指标

---

### P3 - 低优先级（可推迟）

#### 11. AdminFeatured.jsx 空文件
**处理方式**：确认是否需要，不需要则删除

#### 12. 代码组织优化（可选）
**处理方式**：
- ProfileComponents.jsx (1,348行) - 可选拆分
- AdminAnnouncements.jsx (1,116行) - 可选拆分
- 非紧急，有空再优化

#### 13. 构建和部署问题诊断
**处理方式**：保持诊断文档，作为问题排查参考

---

## 修复路线图

### 第1-2周
**目标**：处理 P1 高优先级问题

- [ ] Token 消耗分析和优化
- [ ] 前端代码分割实现
- [ ] AI 响应优化
- [ ] 图片懒加载实现

### 第3-4周
**目标**：开始处理 P2 问题

- [ ] 文档系统整合
- [ ] 暗色模式修复

### 第2-3个月
**目标**：完成 P2 问题

- [ ] 智能搜索功能验证
- [ ] 移动端布局优化
- [ ] 云函数冷启动优化
- [ ] 前端性能监控

---

## 下一步行动

### 本周任务

#### 1. Token 使用分析
```
提示词：
请检查 functions/callAIModel.ts 中的 Prompt Caching 配置，
验证是否正确实现，并分析 Token 使用情况。
```

#### 2. 前端代码分割
```
提示词：
请将 src/pages.config.js 中的页面导入改为 React.lazy 懒加载，
并在 App.jsx 中添加 Suspense 和 Loading 组件。
```

#### 3. 图片懒加载
```
提示词：
请为项目中的图片组件添加 loading="lazy" 属性实现懒加载。
```

---

## 成功指标

| 指标 | 当前值 | 目标值 | 验证方法 |
|------|--------|--------|----------|
| 首屏加载时间 | ~3s | < 1.5s | Lighthouse |
| Token 缓存命中率 | 未知 | > 80% | 日志监控 |
| 移动端体验 | 待评估 | 良好 | 用户反馈 |

---

*路线图更新时间：2026-01-11*
*下次更新：每周五*
