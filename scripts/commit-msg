#!/bin/bash
#
# Git Commit Message Checker
# 检查提交信息是否符合规范
#
# 规范格式:
#   <type>: <subject>
#
# 允许的 type:
#   feat     - 新功能
#   fix      - Bug 修复
#   docs     - 文档更新
#   style    - 代码格式（不影响功能）
#   refactor - 重构
#   perf     - 性能优化
#   test     - 测试相关
#   chore    - 构建/工具变动
#   revert   - 回滚
#

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# 跳过 merge 提交
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# 检查提交信息格式
PATTERN="^(feat|fix|docs|style|refactor|perf|test|chore|revert|debug)(\(.+\))?: .{1,100}"

if ! echo "$COMMIT_MSG" | head -1 | grep -qE "$PATTERN"; then
    echo ""
    echo "❌ 提交信息格式不符合规范!"
    echo ""
    echo "正确格式: <type>: <subject>"
    echo ""
    echo "允许的 type:"
    echo "  feat     - 新功能"
    echo "  fix      - Bug 修复"
    echo "  docs     - 文档更新"
    echo "  style    - 代码格式"
    echo "  refactor - 重构"
    echo "  perf     - 性能优化"
    echo "  test     - 测试相关"
    echo "  chore    - 构建/工具"
    echo "  revert   - 回滚"
    echo ""
    echo "示例:"
    echo "  feat: 添加用户登录功能"
    echo "  fix: 修复对话历史不显示问题"
    echo "  docs: 更新 README 文档"
    echo ""
    echo "你的提交信息: $COMMIT_MSG"
    echo ""
    exit 1
fi

# 检查 subject 长度
SUBJECT_LENGTH=$(echo "$COMMIT_MSG" | head -1 | wc -c)
if [ "$SUBJECT_LENGTH" -gt 100 ]; then
    echo ""
    echo "⚠️  提交信息标题过长 ($SUBJECT_LENGTH 字符)"
    echo "建议控制在 100 字符以内"
    echo ""
fi

exit 0
